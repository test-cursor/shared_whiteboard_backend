<!-- Generated by SpecStory -->

# Debugging Failing Tests (2025-04-22 18:05:12)

_**User**_

i have a lot of failing tests! run the tests and inspect why they fail. then fix them

---

_**Assistant**_

I'll help you run the tests and analyze any failures. Let's start by running the tests to see what's failing.

First, I'll run pytest with detailed output to see the test failures:

---

```bash
cd /Users/dhiraj/Desktop/code/test-crud && python -m pytest app/tests -v
```

```
 pytest app/tests -v        cd /Users/dhiraj/Desktop/code/test-crud && python -m pytest app/tests -v       c
d /Users/dhiraj/Desktop/code/test-crud && python -m pytest app/tests -v
/Library/Developer/CommandLineTools/usr/bin/python3: No module named pytest
(venv) test-crud [main●●] %
```

---

I see that pytest isn't installed in the virtual environment. Let's first install the test requirements:

---

```bash
pip install -r app/tests/requirements-test.txt
```

---

_**User**_

oh whoops, make sure u source the venv then install

---

_**Assistant**_

Ah yes, let's activate the virtual environment first and then install the test requirements:

---

```bash
source venv/bin/activate && pip install -r app/tests/requirements-test.txt
```

```
(venv) test-crud [main●●] % source venv/bin/activate && pip install -r app/tests/requirements-test.txt
Requirement already satisfied: pytest==8.0.2 in ./venv/lib/python3.12/site-packages (from -r app/tests/requi
rements-test.txt (line 1)) (8.0.2)
Requirement already satisfied: pytest-asyncio==0.23.5 in ./venv/lib/python3.12/site-packages (from -r app/te
sts/requirements-test.txt (line 2)) (0.23.5)
Requirement already satisfied: pytest-cov==4.1.0 in ./venv/lib/python3.12/site-packages (from -r app/tests/r
equirements-test.txt (line 3)) (4.1.0)
Requirement already satisfied: httpx==0.27.0 in ./venv/lib/python3.12/site-packages (from -r app/tests/requi
rements-test.txt (line 4)) (0.27.0)
Requirement already satisfied: aiohttp==3.9.3 in ./venv/lib/python3.12/site-packages (from -r app/tests/requ
irements-test.txt (line 5)) (3.9.3)
Requirement already satisfied: websockets==12.0 in ./venv/lib/python3.12/site-packages (from -r app/tests/re
quirements-test.txt (line 6)) (12.0)
Requirement already satisfied: requests==2.31.0 in ./venv/lib/python3.12/site-packages (from -r app/tests/re
quirements-test.txt (line 7)) (2.31.0)
Requirement already satisfied: iniconfig in ./venv/lib/python3.12/site-packages (from pytest==8.0.2->-r app/
tests/requirements-test.txt (line 1)) (2.1.0)
Requirement already satisfied: packaging in ./venv/lib/python3.12/site-packages (from pytest==8.0.2->-r app/
tests/requirements-test.txt (line 1)) (25.0)
Requirement already satisfied: pluggy<2.0,>=1.3.0 in ./venv/lib/python3.12/site-packages (from pytest==8.0.2
->-r app/tests/requirements-test.txt (line 1)) (1.5.0)
Requirement already satisfied: coverage>=5.2.1 in ./venv/lib/python3.12/site-packages (from coverage[toml]>=
5.2.1->pytest-cov==4.1.0->-r app/tests/requirements-test.txt (line 3)) (7.8.0)
Requirement already satisfied: anyio in ./venv/lib/python3.12/site-packages (from httpx==0.27.0->-r app/test
s/requirements-test.txt (line 4)) (4.9.0)
Requirement already satisfied: certifi in ./venv/lib/python3.12/site-packages (from httpx==0.27.0->-r app/te
sts/requirements-test.txt (line 4)) (2025.1.31)
Requirement already satisfied: httpcore==1.* in ./venv/lib/python3.12/site-packages (from httpx==0.27.0->-r 
app/tests/requirements-test.txt (line 4)) (1.0.8)
Requirement already satisfied: idna in ./venv/lib/python3.12/site-packages (from httpx==0.27.0->-r app/tests
/requirements-test.txt (line 4)) (3.10)
Requirement already satisfied: sniffio in ./venv/lib/python3.12/site-packages (from httpx==0.27.0->-r app/te
sts/requirements-test.txt (line 4)) (1.3.1)
Requirement already satisfied: aiosignal>=1.1.2 in ./venv/lib/python3.12/site-packages (from aiohttp==3.9.3-
>-r app/tests/requirements-test.txt (line 5)) (1.3.2)
Requirement already satisfied: attrs>=17.3.0 in ./venv/lib/python3.12/site-packages (from aiohttp==3.9.3->-r
 app/tests/requirements-test.txt (line 5)) (25.3.0)
Requirement already satisfied: frozenlist>=1.1.1 in ./venv/lib/python3.12/site-packages (from aiohttp==3.9.3
->-r app/tests/requirements-test.txt (line 5)) (1.6.0)
Requirement already satisfied: multidict<7.0,>=4.5 in ./venv/lib/python3.12/site-packages (from aiohttp==3.9
.3->-r app/tests/requirements-test.txt (line 5)) (6.4.3)
Requirement already satisfied: yarl<2.0,>=1.0 in ./venv/lib/python3.12/site-packages (from aiohttp==3.9.3->-
r app/tests/requirements-test.txt (line 5)) (1.20.0)
Requirement already satisfied: charset-normalizer<4,>=2 in ./venv/lib/python3.12/site-packages (from request
s==2.31.0->-r app/tests/requirements-test.txt (line 7)) (3.4.1)
Requirement already satisfied: urllib3<3,>=1.21.1 in ./venv/lib/python3.12/site-packages (from requests==2.3
1.0->-r app/tests/requirements-test.txt (line 7)) (2.4.0)
Requirement already satisfied: h11<0.15,>=0.13 in ./venv/lib/python3.12/site-packages (from httpcore==1.*->h
ttpx==0.27.0->-r app/tests/requirements-test.txt (line 4)) (0.14.0)
Requirement already satisfied: propcache>=0.2.1 in ./venv/lib/python3.12/site-packages (from yarl<2.0,>=1.0-
>aiohttp==3.9.3->-r app/tests/requirements-test.txt (line 5)) (0.3.1)
Requirement already satisfied: typing_extensions>=4.5 in ./venv/lib/python3.12/site-packages (from anyio->ht
tpx==0.27.0->-r app/tests/requirements-test.txt (line 4)) (4.13.2)

[notice] A new release of pip is available: 24.2 -> 25.0.1
[notice] To update, run: pip install --upgrade pip
(venv) (venv) test-crud [main●●] %
```

---

Now let's run the tests to see what's failing:

---

```bash
pytest app/tests -v
```

```
(venv) (venv) test-crud [main●●] % 
    def auth_token(session):
        """Create a test user and return their auth token"""
        token_data = {"sub": "testuser"}
        token = create_access_token(token_data)
    
        # Create user session
        user_session = UserSession(
            token=token,
            username="testuser",
            room_id=None
        )
        session.add(user_session)
>       session.commit()

app/tests/test_websocket.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4353: in flush
    self._flush(objects)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4488: in _flush
    with util.safe_reraise():
venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4449: in _flush
    flush_context.execute()
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1843: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2352: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10b7b3380>
cursor = <sqlite3.Cursor object at 0x10d0e1d40>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.7Ycz13MJ
DeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.343952')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10d6455e0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint failed: usersession.room
_id
E       [SQL: INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)]
E       [parameters: ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.
7Ycz13MJDeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.343952')]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError
___________________________ ERROR at setup of test_websocket_disconnect_cleanup ____________________________

self = <sqlalchemy.engine.base.Connection object at 0x10d645ac0>
dialect = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10d647a10>
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10d644ef0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x10d645b20>
parameters = [('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.7Ycz13M
JDeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.641798')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10d647a10>
cursor = <sqlite3.Cursor object at 0x10b96a4c0>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.7Ycz13MJ
DeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.641798')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10d644ef0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlite3.IntegrityError: NOT NULL constraint failed: usersession.room_id

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError

The above exception was the direct cause of the following exception:

session = <sqlmodel.orm.session.Session object at 0x10b7ff9e0>

    @pytest.fixture
    def auth_token(session):
        """Create a test user and return their auth token"""
        token_data = {"sub": "testuser"}
        token = create_access_token(token_data)
    
        # Create user session
        user_session = UserSession(
            token=token,
            username="testuser",
            room_id=None
        )
        session.add(user_session)
>       session.commit()

app/tests/test_websocket.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4353: in flush
    self._flush(objects)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4488: in _flush
    with util.safe_reraise():
venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4449: in _flush
    flush_context.execute()
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1843: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2352: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10d647a10>
cursor = <sqlite3.Cursor object at 0x10b96a4c0>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.7Ycz13MJ
DeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.641798')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10d644ef0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint failed: usersession.room
_id
E       [SQL: INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)]
E       [parameters: ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.
7Ycz13MJDeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.641798')]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError
_________________________ ERROR at setup of test_websocket_invalid_message_format __________________________

self = <sqlalchemy.engine.base.Connection object at 0x10d6f6480>
dialect = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10d6f64e0>
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10d6f42c0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x10d6f4320>
parameters = [('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.7Ycz13M
JDeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.943420')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10d6f64e0>
cursor = <sqlite3.Cursor object at 0x10d002840>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.7Ycz13MJ
DeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.943420')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10d6f42c0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlite3.IntegrityError: NOT NULL constraint failed: usersession.room_id

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError

The above exception was the direct cause of the following exception:

session = <sqlmodel.orm.session.Session object at 0x10d646de0>

    @pytest.fixture
    def auth_token(session):
        """Create a test user and return their auth token"""
        token_data = {"sub": "testuser"}
        token = create_access_token(token_data)
    
        # Create user session
        user_session = UserSession(
            token=token,
            username="testuser",
            room_id=None
        )
        session.add(user_session)
>       session.commit()

app/tests/test_websocket.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4353: in flush
    self._flush(objects)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4488: in _flush
    with util.safe_reraise():
venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4449: in _flush
    flush_context.execute()
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1843: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2352: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10d6f64e0>
cursor = <sqlite3.Cursor object at 0x10d002840>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.7Ycz13MJ
DeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.943420')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10d6f42c0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint failed: usersession.room
_id
E       [SQL: INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)]
E       [parameters: ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5NH0.
7Ycz13MJDeLf2rG3pWQSpDkFM5ojpddWfUjdIaNLecQ', 'testuser', None, '2025-04-23 01:06:34.943420')]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError
================================================= FAILURES =================================================
____________________________________________ test_login_success ____________________________________________

client = <starlette.testclient.TestClient object at 0x10b588050>
session = <sqlmodel.orm.session.Session object at 0x10b576f60>

    def test_login_success(client: TestClient, session):
        """Test successful login with valid username"""
>       response = client.post(
            "/api/v1/auth/login",
            json={"username": "testuser"}
        )

app/tests/test_auth.py:8: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:415: in request
    return super().request(
venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:243: in send
    raise exc from None
venv/lib/python3.12/site-packages/starlette/testclient.py:240: in send
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:181: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:159: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:78: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:82: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/exceptions.py:71: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:241: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:52: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:226: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:159: in run_endpoint_function
    return await dependant.call(**values)
app/api/routes/auth.py:27: in login
    session.commit()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4353: in flush
    self._flush(objects)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4488: in _flush
    with util.safe_reraise():
venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4449: in _flush
    flush_context.execute()
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1843: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2352: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10b5fd7c0>
cursor = <sqlite3.Cursor object at 0x10b7381c0>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5Mn0.b2z_Fbir
w0l0G31QoOueeknU6IkHdaDMnO6f8T_ksWY', 'testuser', None, '2025-04-23 01:06:32.414139')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10b724ef0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint failed: usersession.room
_id
E       [SQL: INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)]
E       [parameters: ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5Mn0.
b2z_Fbirw0l0G31QoOueeknU6IkHdaDMnO6f8T_ksWY', 'testuser', None, '2025-04-23 01:06:32.414139')]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError
________________________________________ test_login_empty_username _________________________________________

client = <starlette.testclient.TestClient object at 0x10b7268d0>

    def test_login_empty_username(client: TestClient):
        """Test login with empty username"""
>       response = client.post(
            "/api/v1/auth/login",
            json={"username": ""}
        )

app/tests/test_auth.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:415: in request
    return super().request(
venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:243: in send
    raise exc from None
venv/lib/python3.12/site-packages/starlette/testclient.py:240: in send
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:181: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:159: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:78: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:82: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/exceptions.py:71: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:241: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:52: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:226: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:159: in run_endpoint_function
    return await dependant.call(**values)
app/api/routes/auth.py:27: in login
    session.commit()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4353: in flush
    self._flush(objects)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4488: in _flush
    with util.safe_reraise():
venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4449: in _flush
    flush_context.execute()
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1843: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2352: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10b726b10>
cursor = <sqlite3.Cursor object at 0x10d5d86c0>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIiLCJleHAiOjE3NDU5NzUxOTJ9.TkeE9Yr9wlsa4VTNS_s
W893wXTpiRvbiA_8v9EtJ-no', '', None, '2025-04-23 01:06:32.855710')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10b7aade0>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint failed: usersession.room
_id
E       [SQL: INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)]
E       [parameters: ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIiLCJleHAiOjE3NDU5NzUxOTJ9.TkeE9Yr9wls
a4VTNS_sW893wXTpiRvbiA_8v9EtJ-no', '', None, '2025-04-23 01:06:32.855710')]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError
______________________________________ test_multiple_logins_same_user ______________________________________

client = <starlette.testclient.TestClient object at 0x10b9ffbc0>
session = <sqlmodel.orm.session.Session object at 0x10b9ff2f0>

    def test_multiple_logins_same_user(client: TestClient, session):
        """Test multiple logins from the same username"""
        # First login
>       response1 = client.post(
            "/api/v1/auth/login",
            json={"username": "testuser"}
        )

app/tests/test_auth.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:415: in request
    return super().request(
venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:243: in send
    raise exc from None
venv/lib/python3.12/site-packages/starlette/testclient.py:240: in send
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:181: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:159: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:78: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:82: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/exceptions.py:71: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:241: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:52: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:226: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:159: in run_endpoint_function
    return await dependant.call(**values)
app/api/routes/auth.py:27: in login
    session.commit()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4353: in flush
    self._flush(objects)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4488: in _flush
    with util.safe_reraise():
venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4449: in _flush
    flush_context.execute()
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1843: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2352: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x10b9fe780>
cursor = <sqlite3.Cursor object at 0x10d67c2c0>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5M30.5Lwc9Hoo
1do3RuSxZPaxAtbpgyd4QW9UUv4ly0UJSMw', 'testuser', None, '2025-04-23 01:06:33.233116')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x10b7fe240>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) NOT NULL constraint failed: usersession.room
_id
E       [SQL: INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)]
E       [parameters: ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTE5M30.
5Lwc9Hoo1do3RuSxZPaxAtbpgyd4QW9UUv4ly0UJSMw', 'testuser', None, '2025-04-23 01:06:33.233116')]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError
____________________________________________ test_room_cleanup _____________________________________________

client = <starlette.testclient.TestClient object at 0x10b7dac60>
session = <sqlmodel.orm.session.Session object at 0x10b7da9f0>
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x10bc0bd30>

    @pytest.mark.asyncio
    async def test_room_cleanup(client: TestClient, session, mock_redis_service):
        """Test room cleanup for inactive rooms"""
        # Create a room
>       response = client.post("/api/v1/rooms")

app/tests/test_rooms.py:57: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:415: in request
    return super().request(
venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:243: in send
    raise exc from None
venv/lib/python3.12/site-packages/starlette/testclient.py:240: in send
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:663: in run_until_complete
    self._check_running()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>

    def _check_running(self):
        if self.is_running():
>           raise RuntimeError('This event loop is already running')
E           RuntimeError: This event loop is already running

/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:622: RuntimeError
_______________________________________ test_websocket_invalid_token _______________________________________

client = <starlette.testclient.TestClient object at 0x10b7fc3e0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x10b7fc3e0>>
test_room = '83dafe0f-abc6-4390-b281-5c6b8f83cb5c'

    def test_websocket_invalid_token(
        client: TestClient,
        websocket_client,
        test_room
    ):
        """Test WebSocket connection with invalid token"""
>       with pytest.raises(Exception):
E       Failed: DID NOT RAISE <class 'Exception'>

app/tests/test_websocket.py:57: Failed
============================================= warnings summary =============================================
venv/lib/python3.12/site-packages/starlette/formparsers.py:8
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/starlette/formparsers.py:8: Pending
DeprecationWarning: Please use `import python_multipart` instead.
    import multipart

app/tests/test_auth.py::test_login_success
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/starlette/testclient.py:234: Deprec
ationWarning: There is no current event loop
    loop = asyncio.get_event_loop()

app/tests/test_auth.py::test_login_success
app/tests/test_auth.py::test_login_empty_username
app/tests/test_auth.py::test_multiple_logins_same_user
app/tests/test_websocket.py::test_websocket_connection_success
app/tests/test_websocket.py::test_websocket_cursor_position
app/tests/test_websocket.py::test_websocket_drawing_action
app/tests/test_websocket.py::test_websocket_disconnect_cleanup
app/tests/test_websocket.py::test_websocket_invalid_message_format
  /Users/dhiraj/Desktop/code/test-crud/app/core/security.py:13: DeprecationWarning: datetime.datetime.utcnow
() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent date
times in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)

app/tests/test_auth.py: 3 warnings
app/tests/test_rooms.py: 24 warnings
app/tests/test_websocket.py: 7 warnings
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/sqlmodel/_compat.py:556: Deprecatio
nWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezo
ne-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    values, fields_set, validation_error = validate_model(self.__class__, data)

app/tests/test_rooms.py::test_room_cleanup
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:769: Depre
cationWarning: The event_loop fixture provided by pytest-asyncio has been redefined in
  /Users/dhiraj/Desktop/code/test-crud/app/tests/conftest.py:68
  Replacing the event_loop fixture with a custom implementation is deprecated
  and will lead to errors in the future.
  If you want to request an asyncio event loop with a scope other than function
  scope, use the "scope" argument to the asyncio mark when marking the tests.
  If you want to return different types of event loops, use the event_loop_policy
  fixture.
  
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
========================================= short test summary info ==========================================
FAILED app/tests/test_auth.py::test_login_success - sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) 
NOT NULL constraint failed: usersession.room_id
FAILED app/tests/test_auth.py::test_login_empty_username - sqlalchemy.exc.IntegrityError: (sqlite3.Integrity
Error) NOT NULL constraint failed: usersession.room_id
FAILED app/tests/test_auth.py::test_multiple_logins_same_user - sqlalchemy.exc.IntegrityError: (sqlite3.Inte
grityError) NOT NULL constraint failed: usersession.room_id
FAILED app/tests/test_rooms.py::test_room_cleanup - RuntimeError: This event loop is already running
FAILED app/tests/test_websocket.py::test_websocket_invalid_token - Failed: DID NOT RAISE <class 'Exception'>
ERROR app/tests/test_websocket.py::test_websocket_connection_success - sqlalchemy.exc.IntegrityError: (sqlit
e3.IntegrityError) NOT NULL constraint failed: usersession.room_id
ERROR app/tests/test_websocket.py::test_websocket_cursor_position - sqlalchemy.exc.IntegrityError: (sqlite3.
IntegrityError) NOT NULL constraint failed: usersession.room_id
ERROR app/tests/test_websocket.py::test_websocket_drawing_action - sqlalchemy.exc.IntegrityError: (sqlite3.I
ntegrityError) NOT NULL constraint failed: usersession.room_id
ERROR app/tests/test_websocket.py::test_websocket_disconnect_cleanup - sqlalchemy.exc.IntegrityError: (sqlit
e3.IntegrityError) NOT NULL constraint failed: usersession.room_id
ERROR app/tests/test_websocket.py::test_websocket_invalid_message_format - sqlalchemy.exc.IntegrityError: (s
qlite3.IntegrityError) NOT NULL constraint failed: usersession.room_id
============================ 5 failed, 5 passed, 45 warnings, 5 errors in 2.92s ============================
sys:1: RuntimeWarning: coroutine 'FastAPI.__call__' was never awaited
RuntimeWarning: Enable tracemalloc to get the object allocation traceback

```

---

I see several issues in the tests. Let me analyze them:

1. The main error is a database constraint error: `NOT NULL constraint failed: usersession.room_id`. This means that the `room_id` field in the `UserSession` model is marked as non-nullable, but we're trying to insert NULL values.

2. There's also an issue with the event loop in `test_room_cleanup`: `RuntimeError: This event loop is already running`

3. The `test_websocket_invalid_token` test is failing because it expects an exception but none is raised.

Let's fix these issues one by one. First, let's look at the UserSession model:

---

<details>
            <summary>Searched codebase "class UserSession model definition" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `app/models/models.py` | L19-26 |
| `app/tests/test_websocket.py` | L1-22 |
| `app/api/routes/auth.py` | L1-32 |
| `app/tests/test_auth.py` | L45-72 |
| `app/tests/test_auth.py` | L1-29 |
| `app/models/models.py` | L1-11 |
| `app/api/routes/room.py` | L37-72 |
| `app/schemas/room.py` | L12-17 |
| `app/schemas/auth.py` | L1-4 |
| `app/api/routes/room.py` | L1-30 |
| `app/tests/test_rooms.py` | L1-21 |
| `app/services/redis_service.py` | L1-58 |
| `app/schemas/room.py` | L27-33 |
| `app/schemas/room.py` | L38-43 |
| `app/schemas/auth.py` | L8-12 |
| `app/db/database.py` | L10-14 |
| `app/tests/conftest.py` | L22-27 |
| `app/schemas/room.py` | L6-12 |
| `app/models/models.py` | L11-19 |
| `app/core/tasks.py` | L1-37 |
| `app/api/routes/room.py` | L72-115 |
| `app/tests/test_websocket.py` | L123-148 |
| `prompt.md` | L74-126 |
| `app/core/config.py` | L1-31 |
| `app/tests/conftest.py` | L27-37 |

</details>

---

I see the issue. In the `UserSession` model, `room_id` is defined as a required field (not nullable), but in both the auth login route and the test fixtures, we're trying to set it to `None`. We need to make this field optional since users don't need to be in a room immediately after login.

Let's modify the `UserSession` model:

---

```diff
      token: str = Field(unique=True)
      username: str
-     room_id: str = Field(foreign_key="room.id")
+     room_id: Optional[str] = Field(default=None, foreign_key="room.id", nullable=True)
      last_active: datetime = Field(default_factory=datetime.utcnow) 
```

---

Now that we've made the `room_id` field optional, we need to recreate the database since we modified the schema. Let's delete the existing database file and it will be recreated when the tests run:

---

```bash
rm -f whiteboard.db
```

```
(venv) (venv) test-crud [main●●] % 

```

---

Now let's run the tests again:

---

```bash
pytest app/tests -v
```

```
=========================================== test session starts ============================================
platform darwin -- Python 3.12.5, pytest-8.0.2, pluggy-1.5.0 -- /Users/dhiraj/Desktop/code/test-crud/venv/bi
n/python3.12
cachedir: .pytest_cache
rootdir: /Users/dhiraj/Desktop/code/test-crud
configfile: pyproject.toml
plugins: asyncio-0.23.5, anyio-4.9.0, cov-4.1.0
asyncio: mode=Mode.STRICT
collected 15 items                                                                                         

app/tests/test_auth.py::test_login_success PASSED                                                    [  6%]
app/tests/test_auth.py::test_login_empty_username FAILED                                             [ 13%]
app/tests/test_auth.py::test_login_missing_username PASSED                                           [ 20%]
app/tests/test_auth.py::test_multiple_logins_same_user FAILED                                        [ 26%]
app/tests/test_rooms.py::test_create_room PASSED                                                     [ 33%]
app/tests/test_rooms.py::test_get_room PASSED                                                        [ 40%]
app/tests/test_rooms.py::test_get_nonexistent_room PASSED                                            [ 46%]
app/tests/test_rooms.py::test_room_limit_per_ip PASSED                                               [ 53%]
app/tests/test_rooms.py::test_room_cleanup FAILED                                                    [ 60%]
app/tests/test_websocket.py::test_websocket_connection_success FAILED                                [ 66%]
app/tests/test_websocket.py::test_websocket_invalid_token FAILED                                     [ 73%]
app/tests/test_websocket.py::test_websocket_cursor_position FAILED                                   [ 80%]
app/tests/test_websocket.py::test_websocket_drawing_action FAILED                                    [ 86%]
app/tests/test_websocket.py::test_websocket_disconnect_cleanup FAILED                                [ 93%]
app/tests/test_websocket.py::test_websocket_invalid_message_format FAILED                            [100%]

================================================= FAILURES =================================================
________________________________________ test_login_empty_username _________________________________________

client = <starlette.testclient.TestClient object at 0x108088f80>

    def test_login_empty_username(client: TestClient):
        """Test login with empty username"""
        response = client.post(
            "/api/v1/auth/login",
            json={"username": ""}
        )
>       assert response.status_code == 422  # Validation error
E       assert 200 == 422
E        +  where 200 = <Response [200]>.status_code

app/tests/test_auth.py:37: AssertionError
______________________________________ test_multiple_logins_same_user ______________________________________

client = <starlette.testclient.TestClient object at 0x1082238f0>
session = <sqlmodel.orm.session.Session object at 0x108223e00>

    def test_multiple_logins_same_user(client: TestClient, session):
        """Test multiple logins from the same username"""
        # First login
        response1 = client.post(
            "/api/v1/auth/login",
            json={"username": "testuser"}
        )
        token1 = response1.json()["access_token"]
    
        # Second login
>       response2 = client.post(
            "/api/v1/auth/login",
            json={"username": "testuser"}
        )

app/tests/test_auth.py:57: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:415: in request
    return super().request(
venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:243: in send
    raise exc from None
venv/lib/python3.12/site-packages/starlette/testclient.py:240: in send
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:181: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:159: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:78: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:82: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/exceptions.py:71: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:241: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:52: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:226: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:159: in run_endpoint_function
    return await dependant.call(**values)
app/api/routes/auth.py:27: in login
    session.commit()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4353: in flush
    self._flush(objects)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4488: in _flush
    with util.safe_reraise():
venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4449: in _flush
    flush_context.execute()
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1843: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2352: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x1082a04a0>
cursor = <sqlite3.Cursor object at 0x108276bc0>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTI5OX0.3pHe0dXL
PoVWgDaNRF8cnULF-2FLyR5JRvwArG3sUow', 'testuser', None, '2025-04-23 01:08:19.946355')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x1082a0c80>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: usersession.token
E       [SQL: INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)]
E       [parameters: ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTI5OX0.
3pHe0dXLPoVWgDaNRF8cnULF-2FLyR5JRvwArG3sUow', 'testuser', None, '2025-04-23 01:08:19.946355')]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError
____________________________________________ test_room_cleanup _____________________________________________

client = <starlette.testclient.TestClient object at 0x10856c290>
session = <sqlmodel.orm.session.Session object at 0x10856e750>
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x108489be0>

    @pytest.mark.asyncio
    async def test_room_cleanup(client: TestClient, session, mock_redis_service):
        """Test room cleanup for inactive rooms"""
        # Create a room
>       response = client.post("/api/v1/rooms")

app/tests/test_rooms.py:57: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:415: in request
    return super().request(
venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:243: in send
    raise exc from None
venv/lib/python3.12/site-packages/starlette/testclient.py:240: in send
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:663: in run_until_complete
    self._check_running()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <_UnixSelectorEventLoop running=False closed=False debug=False>

    def _check_running(self):
        if self.is_running():
>           raise RuntimeError('This event loop is already running')
E           RuntimeError: This event loop is already running

/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:622: RuntimeError
____________________________________ test_websocket_connection_success _____________________________________

client = <starlette.testclient.TestClient object at 0x10856ecc0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x10856ecc0>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyH
DfTFwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
test_room = 'c2164363-809f-4337-a154-d1c21d9c005c'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x108489080>

    def test_websocket_connection_success(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test successful WebSocket connection"""
        with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:
            # Verify connection is established
>           assert websocket.accepted
E           AttributeError: 'WebSocketTestSession' object has no attribute 'accepted'

app/tests/test_websocket.py:42: AttributeError

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x10856ecc0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x10856ecc0>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyH
DfTFwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
test_room = 'c2164363-809f-4337-a154-d1c21d9c005c'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x108489080>

    def test_websocket_connection_success(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test successful WebSocket connection"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x107c9bb60>
room_id = 'c2164363-809f-4337-a154-d1c21d9c005c'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyHDfT
FwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
_______________________________________ test_websocket_invalid_token _______________________________________

client = <starlette.testclient.TestClient object at 0x10856edb0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x10856edb0>>
test_room = '72384940-06cd-4c9f-ac5b-5645770a4202'

    def test_websocket_invalid_token(
        client: TestClient,
        websocket_client,
        test_room
    ):
        """Test WebSocket connection with invalid token"""
>       with pytest.raises(Exception):
E       Failed: DID NOT RAISE <class 'Exception'>

app/tests/test_websocket.py:57: Failed
______________________________________ test_websocket_cursor_position ______________________________________

client = <starlette.testclient.TestClient object at 0x1082a0ef0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1082a0ef0>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyH
DfTFwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
test_room = 'ffb681fe-26a7-40f1-ada4-64cd0437cc8b'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x10848b5e0>

    def test_websocket_cursor_position(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test sending and receiving cursor position updates"""
        with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:
            # Send cursor position
            cursor_data = {
                "type": "cursor_position",
                "data": {
                    "x": 100,
                    "y": 200,
                    "timestamp": "2024-03-14T12:00:00"
                }
            }
            websocket.send_json(cursor_data)
    
            # Setup mock response
>           mock_redis_service.get_room_users.return_value = {"testuser": "testuser"}
E           AttributeError: 'async_generator' object has no attribute 'get_room_users'

app/tests/test_websocket.py:86: AttributeError

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x1082a0ef0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1082a0ef0>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyH
DfTFwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
test_room = 'ffb681fe-26a7-40f1-ada4-64cd0437cc8b'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x10848b5e0>

    def test_websocket_cursor_position(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test sending and receiving cursor position updates"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x107c9bb60>
room_id = 'ffb681fe-26a7-40f1-ada4-64cd0437cc8b'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyHDfT
FwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
______________________________________ test_websocket_drawing_action _______________________________________

client = <starlette.testclient.TestClient object at 0x1082227e0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1082227e0>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyH
DfTFwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
test_room = '28a2a027-95be-496d-b06b-32e87e10f567'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x1080af6b0>

    def test_websocket_drawing_action(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test sending and receiving drawing actions"""
        with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:
            # Send drawing action
            drawing_data = {
                "type": "drawing_action",
                "data": {
                    "action": "draw",
                    "points": [[100, 100], [200, 200]]
                }
            }
            websocket.send_json(drawing_data)
    
            # Verify drawing action was added to Redis
>           mock_redis_service.add_drawing_action.assert_called_once_with(
                test_room,
                drawing_data["data"]
            )
E           AttributeError: 'async_generator' object has no attribute 'add_drawing_action'

app/tests/test_websocket.py:120: AttributeError

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x1082227e0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1082227e0>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyH
DfTFwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
test_room = '28a2a027-95be-496d-b06b-32e87e10f567'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x1080af6b0>

    def test_websocket_drawing_action(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test sending and receiving drawing actions"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:106: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x107c9bb60>
room_id = '28a2a027-95be-496d-b06b-32e87e10f567'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyHDfT
FwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
____________________________________ test_websocket_disconnect_cleanup _____________________________________

client = <starlette.testclient.TestClient object at 0x108d36d80>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x108d36d80>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyH
DfTFwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
test_room = '81ba6f04-c879-437e-92dd-abbd92ec543c'
session = <sqlmodel.orm.session.Session object at 0x108d373b0>
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x10827a0c0>

    @pytest.mark.asyncio
    async def test_websocket_disconnect_cleanup(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        session,
        mock_redis_service
    ):
        """Test cleanup after WebSocket disconnection"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:135: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x107c9bb60>
room_id = '81ba6f04-c879-437e-92dd-abbd92ec543c'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyHDfT
FwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
__________________________________ test_websocket_invalid_message_format ___________________________________

client = <starlette.testclient.TestClient object at 0x108d03bc0>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x108d03bc0>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyH
DfTFwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
test_room = '06fe5c6c-1c5d-4fca-80fc-359d0c068849'

    def test_websocket_invalid_message_format(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room
    ):
        """Test sending invalid message format"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x107c9bb60>
room_id = '06fe5c6c-1c5d-4fca-80fc-359d0c068849'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTMwMH0.4eP9NvuyHDfT
FwVf9vAYPmV_O_9t4vfSjGUaLgzoH_o'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
============================================= warnings summary =============================================
venv/lib/python3.12/site-packages/starlette/formparsers.py:8
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/starlette/formparsers.py:8: Pending
DeprecationWarning: Please use `import python_multipart` instead.
    import multipart

app/tests/test_auth.py::test_login_success
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/starlette/testclient.py:234: Deprec
ationWarning: There is no current event loop
    loop = asyncio.get_event_loop()

app/tests/test_auth.py::test_login_success
app/tests/test_auth.py::test_login_empty_username
app/tests/test_auth.py::test_multiple_logins_same_user
app/tests/test_auth.py::test_multiple_logins_same_user
app/tests/test_websocket.py::test_websocket_connection_success
app/tests/test_websocket.py::test_websocket_cursor_position
app/tests/test_websocket.py::test_websocket_drawing_action
app/tests/test_websocket.py::test_websocket_disconnect_cleanup
app/tests/test_websocket.py::test_websocket_invalid_message_format
  /Users/dhiraj/Desktop/code/test-crud/app/core/security.py:13: DeprecationWarning: datetime.datetime.utcnow
() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent date
times in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)

app/tests/test_auth.py: 4 warnings
app/tests/test_rooms.py: 24 warnings
app/tests/test_websocket.py: 17 warnings
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/sqlmodel/_compat.py:556: Deprecatio
nWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezo
ne-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    values, fields_set, validation_error = validate_model(self.__class__, data)

app/tests/test_auth.py::test_login_success
  /Users/dhiraj/Desktop/code/test-crud/app/tests/test_auth.py:27: DeprecationWarning: 
          🚨 You probably want to use `session.exec()` instead of `session.query()`.
  
          `session.exec()` is SQLModel's own short version with increased type
          annotations.
  
          Or otherwise you might want to use `session.execute()` instead of
          `session.query()`.
          
    user_session = session.query(UserSession).filter(UserSession.token == token).first()

app/tests/test_rooms.py::test_room_cleanup
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:769: Depre
cationWarning: The event_loop fixture provided by pytest-asyncio has been redefined in
  /Users/dhiraj/Desktop/code/test-crud/app/tests/conftest.py:68
  Replacing the event_loop fixture with a custom implementation is deprecated
  and will lead to errors in the future.
  If you want to request an asyncio event loop with a scope other than function
  scope, use the "scope" argument to the asyncio mark when marking the tests.
  If you want to return different types of event loops, use the event_loop_policy
  fixture.
  
    warnings.warn(

app/tests/test_websocket.py::test_websocket_connection_success
app/tests/test_websocket.py::test_websocket_cursor_position
app/tests/test_websocket.py::test_websocket_drawing_action
app/tests/test_websocket.py::test_websocket_disconnect_cleanup
app/tests/test_websocket.py::test_websocket_invalid_message_format
  /Users/dhiraj/Desktop/code/test-crud/app/api/routes/room.py:67: DeprecationWarning: datetime.datetime.utcn
ow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent da
tetimes in UTC: datetime.datetime.now(datetime.UTC).
    user_session.last_active = datetime.utcnow()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
========================================= short test summary info ==========================================
FAILED app/tests/test_auth.py::test_login_empty_username - assert 200 == 422
FAILED app/tests/test_auth.py::test_multiple_logins_same_user - sqlalchemy.exc.IntegrityError: (sqlite3.Inte
grityError) UNIQUE constraint failed: usersession.token
FAILED app/tests/test_rooms.py::test_room_cleanup - RuntimeError: This event loop is already running
FAILED app/tests/test_websocket.py::test_websocket_connection_success - AttributeError: 'NoneType' object ha
s no attribute 'hset'
FAILED app/tests/test_websocket.py::test_websocket_invalid_token - Failed: DID NOT RAISE <class 'Exception'>
FAILED app/tests/test_websocket.py::test_websocket_cursor_position - AttributeError: 'NoneType' object has n
o attribute 'hset'
FAILED app/tests/test_websocket.py::test_websocket_drawing_action - AttributeError: 'NoneType' object has no
 attribute 'hset'
FAILED app/tests/test_websocket.py::test_websocket_disconnect_cleanup - AttributeError: 'NoneType' object ha
s no attribute 'hset'
FAILED app/tests/test_websocket.py::test_websocket_invalid_message_format - AttributeError: 'NoneType' objec
t has no attribute 'hset'
================================= 9 failed, 6 passed, 63 warnings in 1.14s =================================

```

---

Now we have several new issues to fix:

1. Empty username validation is not working - `test_login_empty_username` expects a 422 error but gets 200
2. Multiple logins with same username fails due to unique token constraint
3. Redis service is not initialized in tests - `'NoneType' object has no attribute 'hset'`
4. Event loop issues in async tests

Let's fix these one by one:

1. First, let's add validation for empty username in the login route:

---

```diff
- from pydantic import BaseModel
+ from pydantic import BaseModel, validator
  
  class UserLogin(BaseModel):
      username: str
+     
+     @validator('username')
+     def username_must_not_be_empty(cls, v):
+         if not v.strip():
+             raise ValueError('username must not be empty')
+         return v
  
  class Token(BaseModel):
```

---

2. For the multiple logins issue, we need to modify the login route to handle existing users:

---

```diff
  from fastapi import APIRouter, Depends, HTTPException
- from sqlmodel import Session
+ from sqlmodel import Session, select
  from app.core.security import create_access_token
  from app.db.database import get_session
      access_token = create_access_token(token_data)
      
+     # Remove any existing sessions for this user
+     existing_sessions = session.exec(
+         select(UserSession).where(UserSession.username == user.username)
+     ).all()
+     for session_obj in existing_sessions:
+         session.delete(session_obj)
+     
      # Create user session
      user_session = UserSession(
```

---

3. For the Redis service initialization in tests, we need to modify the mock Redis service fixture:

---

<details>
            <summary>Searched codebase "mock_redis_service_fixture in conftest.py" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `app/tests/conftest.py` | L37-60 |
| `app/tests/conftest.py` | L1-22 |
| `app/services/redis_service.py` | L68-71 |
| `app/tests/test_rooms.py` | L51-75 |
| `app/tests/test_websocket.py` | L96-123 |
| `app/tests/test_websocket.py` | L28-49 |
| `app/tests/test_websocket.py` | L123-148 |
| `app/services/redis_service.py` | L58-68 |
| `app/services/redis_service.py` | L1-58 |
| `app/tests/test_websocket.py` | L61-96 |
| `app/core/config.py` | L1-31 |
| `app/tests/conftest.py` | L27-37 |
| `app/main.py` | L38-45 |
| `app/main.py` | L1-38 |
| `app/tests/conftest.py` | L60-65 |
| `app/tests/test_websocket.py` | L1-22 |
| `app/tests/test_websocket.py` | L22-28 |
| `app/core/tasks.py` | L1-37 |
| `app/tests/conftest.py` | L22-27 |
| `app/api/routes/room.py` | L37-72 |
| `app/tests/conftest.py` | L65-72 |
| `app/api/routes/room.py` | L1-30 |
| `requirements.txt` | L1-10 |
| `app/tests/test_rooms.py` | L21-34 |
| `app/tests/test_rooms.py` | L1-21 |

</details>

---

Let's modify the mock Redis service fixture to properly initialize the mock:

---

```diff
  @pytest.fixture(name="mock_redis_service")
  async def mock_redis_service_fixture():
-     # Create a mock Redis service with async methods
+     # Create a mock Redis service
      mock_service = AsyncMock(spec=RedisService)
+     mock_service.redis = AsyncMock()  # Add mock redis instance
      
      # Setup default behaviors for commonly used methods
```

---

4. For the event loop issues, we need to modify the event loop fixture to handle nested event loops:

---

```diff
  import pytest
  import asyncio
+ import nest_asyncio
  from typing import AsyncGenerator, Generator
  from fastapi.testclient import TestClient
  def event_loop():
      loop = asyncio.get_event_loop_policy().new_event_loop()
+     nest_asyncio.apply(loop)  # Allow nested event loops
      yield loop
      loop.close() 
```

---

We need to install the `nest_asyncio` package:

---

```bash
pip install nest_asyncio
```

```
Collecting nest_asyncio
  Downloading nest_asyncio-1.6.0-py3-none-any.whl.metadata (2.8 kB)
Downloading nest_asyncio-1.6.0-py3-none-any.whl (5.2 kB)
Installing collected packages: nest_asyncio
Successfully installed nest_asyncio-1.6.0

[notice] A new release of pip is available: 24.2 -> 25.0.1
[notice] To update, run: pip install --upgrade pip

```

---

Now let's run the tests again:

---

```bash
pytest app/tests -v
```

```
=========================================== test session starts ============================================
platform darwin -- Python 3.12.5, pytest-8.0.2, pluggy-1.5.0 -- /Users/dhiraj/Desktop/code/test-crud/venv/bi
n/python3.12
cachedir: .pytest_cache
rootdir: /Users/dhiraj/Desktop/code/test-crud
configfile: pyproject.toml
plugins: asyncio-0.23.5, anyio-4.9.0, cov-4.1.0
asyncio: mode=Mode.STRICT
collected 15 items                                                                                         

app/tests/test_auth.py::test_login_success PASSED                                                    [  6%]
app/tests/test_auth.py::test_login_empty_username PASSED                                             [ 13%]
app/tests/test_auth.py::test_login_missing_username PASSED                                           [ 20%]
app/tests/test_auth.py::test_multiple_logins_same_user FAILED                                        [ 26%]
app/tests/test_rooms.py::test_create_room PASSED                                                     [ 33%]
app/tests/test_rooms.py::test_get_room PASSED                                                        [ 40%]
app/tests/test_rooms.py::test_get_nonexistent_room PASSED                                            [ 46%]
app/tests/test_rooms.py::test_room_limit_per_ip PASSED                                               [ 53%]
app/tests/test_rooms.py::test_room_cleanup FAILED                                                    [ 60%]
app/tests/test_websocket.py::test_websocket_connection_success FAILED                                [ 66%]
app/tests/test_websocket.py::test_websocket_invalid_token FAILED                                     [ 73%]
app/tests/test_websocket.py::test_websocket_cursor_position FAILED                                   [ 80%]
app/tests/test_websocket.py::test_websocket_drawing_action FAILED                                    [ 86%]
app/tests/test_websocket.py::test_websocket_disconnect_cleanup FAILED                                [ 93%]
app/tests/test_websocket.py::test_websocket_invalid_message_format FAILED                            [100%]

================================================= FAILURES =================================================
______________________________________ test_multiple_logins_same_user ______________________________________

client = <starlette.testclient.TestClient object at 0x111480050>
session = <sqlmodel.orm.session.Session object at 0x111480110>

    def test_multiple_logins_same_user(client: TestClient, session):
        """Test multiple logins from the same username"""
        # First login
        response1 = client.post(
            "/api/v1/auth/login",
            json={"username": "testuser"}
        )
        token1 = response1.json()["access_token"]
    
        # Second login
>       response2 = client.post(
            "/api/v1/auth/login",
            json={"username": "testuser"}
        )

app/tests/test_auth.py:57: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/requests/sessions.py:637: in post
    return self.request("POST", url, data=data, json=json, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:415: in request
    return super().request(
venv/lib/python3.12/site-packages/requests/sessions.py:589: in request
    resp = self.send(prep, **send_kwargs)
venv/lib/python3.12/site-packages/requests/sessions.py:703: in send
    r = adapter.send(request, **kwargs)
venv/lib/python3.12/site-packages/starlette/testclient.py:243: in send
    raise exc from None
venv/lib/python3.12/site-packages/starlette/testclient.py:240: in send
    loop.run_until_complete(self.app(scope, receive, send))
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/bas
e_events.py:687: in run_until_complete
    return future.result()
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:181: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:159: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:78: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:82: in __call__
    raise exc from None
venv/lib/python3.12/site-packages/starlette/exceptions.py:71: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:241: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:52: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:226: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:159: in run_endpoint_function
    return await dependant.call(**values)
app/api/routes/auth.py:34: in login
    session.commit()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2032: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4353: in flush
    self._flush(objects)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4488: in _flush
    with util.safe_reraise():
venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4449: in _flush
    flush_context.execute()
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1233: in _emit_insert_statements
    result = connection.execute(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1416: in execute
    return meth(
venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1843: in _execute_context
    return self._exec_single_context(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2352: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1964: in _exec_single_context
    self.dialect.do_execute(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <sqlalchemy.dialects.sqlite.pysqlite.SQLiteDialect_pysqlite object at 0x111480950>
cursor = <sqlite3.Cursor object at 0x1114762c0>
statement = 'INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)'
parameters = ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNX0.yXhN9EEI
TF4ylY79ilyelOuZyCqNeo5dSbAtkqQzf1o', 'testuser', None, '2025-04-23 01:10:35.219367')
context = <sqlalchemy.dialects.sqlite.base.SQLiteExecutionContext object at 0x111481700>

    def do_execute(self, cursor, statement, parameters, context=None):
>       cursor.execute(statement, parameters)
E       sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: usersession.token
E       [SQL: INSERT INTO usersession (token, username, room_id, last_active) VALUES (?, ?, ?, ?)]
E       [parameters: ('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNX0.
yXhN9EEITF4ylY79ilyelOuZyCqNeo5dSbAtkqQzf1o', 'testuser', None, '2025-04-23 01:10:35.219367')]
E       (Background on this error at: https://sqlalche.me/e/20/gkpj)

venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:945: IntegrityError
____________________________________________ test_room_cleanup _____________________________________________

client = <starlette.testclient.TestClient object at 0x11176b4a0>
session = <sqlmodel.orm.session.Session object at 0x11176b0b0>
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x11197edc0>

    @pytest.mark.asyncio
    async def test_room_cleanup(client: TestClient, session, mock_redis_service):
        """Test room cleanup for inactive rooms"""
        # Create a room
        response = client.post("/api/v1/rooms")
        room_id = response.json()["id"]
    
        # Get the room and modify its last_activity to be old
        room = session.get(Room, room_id)
        room.last_activity = datetime.utcnow() - timedelta(minutes=10)
        session.add(room)
        session.commit()
    
        # Import and run cleanup
        from app.core.tasks import cleanup_inactive_rooms
        await cleanup_inactive_rooms()
    
        # Verify room was deleted
        room = session.get(Room, room_id)
>       assert room is None
E       AssertionError: assert Room(active_user_count=0, last_activity=datetime.datetime(2025, 4, 23, 1, 0, 
35, 974632), creator_ip='testclient', id='2ceb155d-3113-4804-b239-76dd5532eeb5', created_at=datetime.datetim
e(2025, 4, 23, 1, 10, 35, 969691)) is None

app/tests/test_rooms.py:72: AssertionError
------------------------------------------- Captured stderr call -------------------------------------------
2025-04-22 18:10:35,978 - app.core.tasks - ERROR - Error in cleanup_inactive_rooms: (sqlite3.OperationalErro
r) no such table: room
[SQL: SELECT room.id, room.created_at, room.last_activity, room.creator_ip, room.active_user_count 
FROM room 
WHERE room.last_activity < ? AND room.active_user_count = ?]
[parameters: ('2025-04-23 01:05:35.976381', 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
-------------------------------------------- Captured log call ---------------------------------------------
ERROR    app.core.tasks:tasks.py:37 Error in cleanup_inactive_rooms: (sqlite3.OperationalError) no such tabl
e: room
[SQL: SELECT room.id, room.created_at, room.last_activity, room.creator_ip, room.active_user_count 
FROM room 
WHERE room.last_activity < ? AND room.active_user_count = ?]
[parameters: ('2025-04-23 01:05:35.976381', 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
____________________________________ test_websocket_connection_success _____________________________________

client = <starlette.testclient.TestClient object at 0x11176a990>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x11176a990>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNX0.yXhN9EEIT
F4ylY79ilyelOuZyCqNeo5dSbAtkqQzf1o'
test_room = '4b08f09b-9c9f-46c1-aa6c-128f36fb2dd0'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x1112ae5a0>

    def test_websocket_connection_success(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test successful WebSocket connection"""
        with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:
            # Verify connection is established
>           assert websocket.accepted
E           AttributeError: 'WebSocketTestSession' object has no attribute 'accepted'

app/tests/test_websocket.py:42: AttributeError

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x11176a990>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x11176a990>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNX0.yXhN9EEIT
F4ylY79ilyelOuZyCqNeo5dSbAtkqQzf1o'
test_room = '4b08f09b-9c9f-46c1-aa6c-128f36fb2dd0'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x1112ae5a0>

    def test_websocket_connection_success(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test successful WebSocket connection"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
venv/lib/python3.12/site-packages/nest_asyncio.py:98: in run_until_complete
    return f.result()
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/fut
ures.py:203: in result
    raise self._exception.with_traceback(self._exception_tb)
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/tas
ks.py:314: in __step_run_and_handle_result
    result = coro.send(None)
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x110d6ce60>
room_id = '4b08f09b-9c9f-46c1-aa6c-128f36fb2dd0'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNX0.yXhN9EEITF4y
lY79ilyelOuZyCqNeo5dSbAtkqQzf1o'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
_______________________________________ test_websocket_invalid_token _______________________________________

client = <starlette.testclient.TestClient object at 0x1114fde20>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1114fde20>>
test_room = '5d873cd7-fc3f-47ad-ae8c-657610b42298'

    def test_websocket_invalid_token(
        client: TestClient,
        websocket_client,
        test_room
    ):
        """Test WebSocket connection with invalid token"""
>       with pytest.raises(Exception):
E       Failed: DID NOT RAISE <class 'Exception'>

app/tests/test_websocket.py:57: Failed
______________________________________ test_websocket_cursor_position ______________________________________

client = <starlette.testclient.TestClient object at 0x1112f3470>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1112f3470>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv
7chN9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
test_room = 'e161bedf-3885-4ac9-ba7f-c00c8a210163'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x11144dd80>

    def test_websocket_cursor_position(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test sending and receiving cursor position updates"""
        with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:
            # Send cursor position
            cursor_data = {
                "type": "cursor_position",
                "data": {
                    "x": 100,
                    "y": 200,
                    "timestamp": "2024-03-14T12:00:00"
                }
            }
            websocket.send_json(cursor_data)
    
            # Setup mock response
>           mock_redis_service.get_room_users.return_value = {"testuser": "testuser"}
E           AttributeError: 'async_generator' object has no attribute 'get_room_users'

app/tests/test_websocket.py:86: AttributeError

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x1112f3470>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1112f3470>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv
7chN9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
test_room = 'e161bedf-3885-4ac9-ba7f-c00c8a210163'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x11144dd80>

    def test_websocket_cursor_position(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test sending and receiving cursor position updates"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
venv/lib/python3.12/site-packages/nest_asyncio.py:98: in run_until_complete
    return f.result()
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/fut
ures.py:203: in result
    raise self._exception.with_traceback(self._exception_tb)
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/tas
ks.py:314: in __step_run_and_handle_result
    result = coro.send(None)
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x110d6ce60>
room_id = 'e161bedf-3885-4ac9-ba7f-c00c8a210163'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv7ch
N9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
______________________________________ test_websocket_drawing_action _______________________________________

client = <starlette.testclient.TestClient object at 0x1114fe930>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1114fe930>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv
7chN9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
test_room = '440a87ee-982c-433c-ab6a-aeb18fac7279'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x11144cd40>

    def test_websocket_drawing_action(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test sending and receiving drawing actions"""
        with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:
            # Send drawing action
            drawing_data = {
                "type": "drawing_action",
                "data": {
                    "action": "draw",
                    "points": [[100, 100], [200, 200]]
                }
            }
            websocket.send_json(drawing_data)
    
            # Verify drawing action was added to Redis
>           mock_redis_service.add_drawing_action.assert_called_once_with(
                test_room,
                drawing_data["data"]
            )
E           AttributeError: 'async_generator' object has no attribute 'add_drawing_action'

app/tests/test_websocket.py:120: AttributeError

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x1114fe930>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x1114fe930>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv
7chN9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
test_room = '440a87ee-982c-433c-ab6a-aeb18fac7279'
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x11144cd40>

    def test_websocket_drawing_action(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        mock_redis_service
    ):
        """Test sending and receiving drawing actions"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:106: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
venv/lib/python3.12/site-packages/nest_asyncio.py:98: in run_until_complete
    return f.result()
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/fut
ures.py:203: in result
    raise self._exception.with_traceback(self._exception_tb)
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/tas
ks.py:314: in __step_run_and_handle_result
    result = coro.send(None)
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x110d6ce60>
room_id = '440a87ee-982c-433c-ab6a-aeb18fac7279'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv7ch
N9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
____________________________________ test_websocket_disconnect_cleanup _____________________________________

client = <starlette.testclient.TestClient object at 0x111f0b620>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x111f0b620>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv
7chN9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
test_room = 'dc6073ec-1ce7-4d01-b81a-867f9695ef0f'
session = <sqlmodel.orm.session.Session object at 0x111f0bb90>
mock_redis_service = <async_generator object mock_redis_service_fixture at 0x11197ef60>

    @pytest.mark.asyncio
    async def test_websocket_disconnect_cleanup(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room,
        session,
        mock_redis_service
    ):
        """Test cleanup after WebSocket disconnection"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:135: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
venv/lib/python3.12/site-packages/nest_asyncio.py:98: in run_until_complete
    return f.result()
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/fut
ures.py:203: in result
    raise self._exception.with_traceback(self._exception_tb)
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/tas
ks.py:314: in __step_run_and_handle_result
    result = coro.send(None)
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x110d6ce60>
room_id = 'dc6073ec-1ce7-4d01-b81a-867f9695ef0f'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv7ch
N9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
__________________________________ test_websocket_invalid_message_format ___________________________________

client = <starlette.testclient.TestClient object at 0x111f1e420>
websocket_client = <bound method TestClient.websocket_connect of <starlette.testclient.TestClient object at 
0x111f1e420>>
auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv
7chN9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
test_room = 'de718dad-849b-4393-b218-55eb4a2062bc'

    def test_websocket_invalid_message_format(
        client: TestClient,
        websocket_client,
        auth_token,
        test_room
    ):
        """Test sending invalid message format"""
>       with websocket_client(
            f"/api/v1/ws/{test_room}?token={auth_token}"
        ) as websocket:

app/tests/test_websocket.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:289: in __exit__
    raise message
venv/lib/python3.12/site-packages/starlette/testclient.py:300: in _run
    loop.run_until_complete(self.app(scope, receive, send))
venv/lib/python3.12/site-packages/nest_asyncio.py:98: in run_until_complete
    return f.result()
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/fut
ures.py:203: in result
    raise self._exception.with_traceback(self._exception_tb)
/opt/homebrew/Cellar/python@3.12/3.12.5/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/tas
ks.py:314: in __step_run_and_handle_result
    result = coro.send(None)
venv/lib/python3.12/site-packages/fastapi/applications.py:208: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:146: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:70: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/exceptions.py:58: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:580: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:297: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:68: in app
    await func(session)
venv/lib/python3.12/site-packages/fastapi/routing.py:273: in app
    await dependant.call(**values)
app/api/routes/room.py:115: in websocket_endpoint
    raise e
app/api/routes/room.py:72: in websocket_endpoint
    await redis_service.add_user_to_room(room_id, token, username)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <app.services.redis_service.RedisService object at 0x110d6ce60>
room_id = 'de718dad-849b-4393-b218-55eb4a2062bc'
user_id = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlciIsImV4cCI6MTc0NTk3NTQzNn0.tBms_sSQv7ch
N9PxAchzw39xJ9I7vWK02n5Dqny8pu8'
username = 'testuser'

    async def add_user_to_room(self, room_id: str, user_id: str, username: str):
>       await self.redis.hset(f"room:{room_id}:users", user_id, username)
E       AttributeError: 'NoneType' object has no attribute 'hset'

app/services/redis_service.py:33: AttributeError
============================================= warnings summary =============================================
venv/lib/python3.12/site-packages/starlette/formparsers.py:8
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/starlette/formparsers.py:8: Pending
DeprecationWarning: Please use `import python_multipart` instead.
    import multipart

app/tests/test_auth.py::test_login_success
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/starlette/testclient.py:234: Deprec
ationWarning: There is no current event loop
    loop = asyncio.get_event_loop()

app/tests/test_auth.py::test_login_success
app/tests/test_auth.py::test_multiple_logins_same_user
app/tests/test_auth.py::test_multiple_logins_same_user
app/tests/test_websocket.py::test_websocket_connection_success
app/tests/test_websocket.py::test_websocket_cursor_position
app/tests/test_websocket.py::test_websocket_drawing_action
app/tests/test_websocket.py::test_websocket_disconnect_cleanup
app/tests/test_websocket.py::test_websocket_invalid_message_format
  /Users/dhiraj/Desktop/code/test-crud/app/core/security.py:13: DeprecationWarning: datetime.datetime.utcnow
() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent date
times in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)

app/tests/test_auth.py: 3 warnings
app/tests/test_rooms.py: 26 warnings
app/tests/test_websocket.py: 17 warnings
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/sqlmodel/_compat.py:556: Deprecatio
nWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezo
ne-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    values, fields_set, validation_error = validate_model(self.__class__, data)

app/tests/test_auth.py::test_login_success
  /Users/dhiraj/Desktop/code/test-crud/app/tests/test_auth.py:27: DeprecationWarning: 
          🚨 You probably want to use `session.exec()` instead of `session.query()`.
  
          `session.exec()` is SQLModel's own short version with increased type
          annotations.
  
          Or otherwise you might want to use `session.execute()` instead of
          `session.query()`.
          
    user_session = session.query(UserSession).filter(UserSession.token == token).first()

app/tests/test_rooms.py::test_room_cleanup
  /Users/dhiraj/Desktop/code/test-crud/venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:769: Depre
cationWarning: The event_loop fixture provided by pytest-asyncio has been redefined in
  /Users/dhiraj/Desktop/code/test-crud/app/tests/conftest.py:70
  Replacing the event_loop fixture with a custom implementation is deprecated
  and will lead to errors in the future.
  If you want to request an asyncio event loop with a scope other than function
  scope, use the "scope" argument to the asyncio mark when marking the tests.
  If you want to return different types of event loops, use the event_loop_policy
  fixture.
  
    warnings.warn(

app/tests/test_rooms.py::test_room_cleanup
  /Users/dhiraj/Desktop/code/test-crud/app/tests/test_rooms.py:62: DeprecationWarning: datetime.datetime.utc
now() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent d
atetimes in UTC: datetime.datetime.now(datetime.UTC).
    room.last_activity = datetime.utcnow() - timedelta(minutes=10)

app/tests/test_rooms.py::test_room_cleanup
  /Users/dhiraj/Desktop/code/test-crud/app/core/tasks.py:16: DeprecationWarning: datetime.datetime.utcnow() 
is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetim
es in UTC: datetime.datetime.now(datetime.UTC).
    cutoff_time = datetime.utcnow() - timedelta(minutes=settings.ROOM_CLEANUP_MINUTES)

app/tests/test_websocket.py::test_websocket_connection_success
app/tests/test_websocket.py::test_websocket_cursor_position
app/tests/test_websocket.py::test_websocket_drawing_action
app/tests/test_websocket.py::test_websocket_disconnect_cleanup
app/tests/test_websocket.py::test_websocket_invalid_message_format
  /Users/dhiraj/Desktop/code/test-crud/app/api/routes/room.py:67: DeprecationWarning: datetime.datetime.utcn
ow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent da
tetimes in UTC: datetime.datetime.now(datetime.UTC).
    user_session.last_active = datetime.utcnow()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
========================================= short test summary info ==========================================
FAILED app/tests/test_auth.py::test_multiple_logins_same_user - sqlalchemy.exc.IntegrityError: (sqlite3.Inte
grityError) UNIQUE constraint failed: usersession.token
FAILED app/tests/test_rooms.py::test_room_cleanup - AssertionError: assert Room(active_user_count=0, last_ac
tivity=datetime.datetime(2025, 4, 23, 1, 0, 35,...
FAILED app/tests/test_websocket.py::test_websocket_connection_success - AttributeError: 'NoneType' object ha
s no attribute 'hset'
FAILED app/tests/test_websocket.py::test_websocket_invalid_token - Failed: DID NOT RAISE <class 'Exception'>
FAILED app/tests/test_websocket.py::test_websocket_cursor_position - AttributeError: 'NoneType' object has n
o attribute 'hset'
FAILED app/tests/test_websocket.py::test_websocket_drawing_action - AttributeError: 'NoneType' object has no
 attribute 'hset'
FAILED app/tests/test_websocket.py::test_websocket_disconnect_cleanup - AttributeError: 'NoneType' object ha
s no attribute 'hset'
FAILED app/tests/test_websocket.py::test_websocket_invalid_message_format - AttributeError: 'NoneType' objec
t has no attribute 'hset'
================================= 8 failed, 7 passed, 65 warnings in 1.68s =================================

```

---

Let's analyze the test failures and fix them one by one:

1. **Multiple Logins Issue**:
```
FAILED app/tests/test_auth.py::test_multiple_logins_same_user - sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: usersession.token
```
We need to ensure that when a user logs in again, we properly handle the existing session. Let me check the auth route:

---

Read file: app/api/routes/auth.py

---

2. **Room Cleanup Issue**:
```
FAILED app/tests/test_rooms.py::test_room_cleanup - AssertionError: assert None is not None
```
Let me check the room cleanup logic:

---

Read file: app/tests/test_rooms.py

---

Let me check the cleanup task implementation:

---

Read file: app/core/tasks.py

---

Let me check the settings to see the cleanup threshold:

---

Read file: app/core/config.py

---

Let me check the Redis service implementation:

---

Read file: app/services/redis_service.py

---

Let me also check the room service implementation:

---

Could not find file 'app/services/room_service.py' in the workspace.

---

Let me check the database models:

---

Could not find file 'app/models/room.py' in the workspace.

---

Let me check the API routes to see how room operations are handled:

---

<details>
            <summary>Listed directory app/api/routes • **3** results</summary>
        
| Name |
|-------|
| 📁 `__pycache__` |
| 📄 `auth.py` |
| 📄 `room.py` |

</details>

---

I'll examine the room routes to understand the API endpoints:

---

Read file: app/api/routes/room.py

---

Let me summarize the room-related API routes and their functionality:

1. **Create Room** (`POST /rooms`)
   - Creates a new room
   - Has IP-based rate limiting (max 10 rooms per IP)
   - Returns a `RoomResponse` object with room details
   - No authentication required

2. **Get Room** (`GET /rooms/{room_id}`)
   - Retrieves room details by room ID
   - Returns a `RoomResponse` object or 404 if not found
   - No authentication required

3. **WebSocket Connection** (`WS /ws/{room_id}`)
   - Handles real-time collaboration features
   - Requires authentication via token
   - Manages:
     - User session tracking
     - Cursor position updates
     - Drawing actions
     - Room user presence
   - Uses Redis for real-time state management
   - Handles disconnections and cleanup

Let me check the room model to understand what data is stored for rooms:

---

<details>
            <summary>Searched codebase "class Room model definition" • **3** results</summary>
        
| File | Lines |
|------|-------|
| `app/models/models.py` | L1-11 |
| `app/models/models.py` | L19-26 |
| `app/models/models.py` | L11-19 |

</details>

---

The Room model has the following fields:
- `id`: UUID string (primary key)
- `created_at`: Creation timestamp
- `last_activity`: Last activity timestamp
- `creator_ip`: IP address of room creator
- `active_user_count`: Number of currently active users

There are also related models:
1. `DrawingData`: Stores drawing actions in a room
   - `room_id`: Foreign key to Room
   - `path_data`: JSON string with vector path data
   - `stroke_width`: Width of stroke
   - `color`: Color of stroke
   - `timestamp`: When drawing was made

2. `UserSession`: Tracks user sessions
   - `token`: Unique session token
   - `username`: User's display name
   - `room_id`: Optional foreign key to Room
   - `last_active`: Last activity timestamp

Let me check if there are any room-related services that implement business logic:

---

<details>
            <summary>Searched codebase "room service class or functions" • **3** results</summary>
        
| File | Lines |
|------|-------|
| `app/services/redis_service.py` | L58-68 |
| `app/services/redis_service.py` | L1-58 |
| `app/services/redis_service.py` | L68-71 |

</details>

---

Let me check for any room-related database services:

---

<details>
            <summary>Searched codebase "room database operations or room repository" • **2** results</summary>
        
| File | Lines |
|------|-------|
| `app/db/database.py` | L1-10 |
| `app/db/database.py` | L10-14 |

</details>

---

Let me also check for room-related models and schemas:

---

<details>
            <summary>Searched codebase "room model schema definition" • **0** results</summary>
        
No results found
</details>

---

Let me also check for room-related services:

---

<details>
            <summary>Searched codebase "room service repository crud operations" • **3** results</summary>
        
| File | Lines |
|------|-------|
| `app/services/redis_service.py` | L1-58 |
| `app/services/redis_service.py` | L58-68 |
| `app/services/redis_service.py` | L68-71 |

</details>

---

Let me also check for any room-related routes:

---

<details>
            <summary>Searched codebase "room api routes endpoints" • **5** results</summary>
        
| File | Lines |
|------|-------|
| `app/api/routes/room.py` | L1-30 |
| `app/api/routes/room.py` | L30-37 |
| `app/api/routes/room.py` | L37-72 |
| `app/api/routes/auth.py` | L1-32 |
| `app/api/routes/room.py` | L72-115 |

</details>

---





---



---

